
<!-- saved from url=(0068)file:///D:/Master/Desktop/sophie/000000%E4%BD%9C%E6%A5%AD/index.html -->
<html lang="zh-TW"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.pointer-events-none{pointer-events:none}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.left-0{left:0px}.left-1\/2{left:50%}.right-0{right:0px}.top-0{top:0px}.top-1\/2{top:50%}.z-10{z-index:10}.z-40{z-index:40}.z-50{z-index:50}.z-\[60\]{z-index:60}.z-\[999\]{z-index:999}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-2{margin-top:0.5rem}.mt-4{margin-top:1rem}.block{display:block}.flex{display:flex}.hidden{display:none}.h-12{height:3rem}.h-4{height:1rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-64{height:16rem}.h-\[1px\]{height:1px}.h-full{height:100%}.h-screen{height:100vh}.w-1\/2{width:50%}.w-4{width:1rem}.w-6{width:1.5rem}.w-64{width:16rem}.w-\[1px\]{width:1px}.w-full{width:100%}.w-screen{width:100vw}.max-w-sm{max-width:24rem}.flex-1{flex:1 1 0%}.-translate-x-1\/2{--tw-translate-x:-50%;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.-translate-y-1\/2{--tw-translate-y:-50%;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.-rotate-90{--tw-rotate:-90deg;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.rotate-90{--tw-rotate:90deg;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}@keyframes pulse{50%{opacity:.5}}.animate-pulse{animation:pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.rounded{border-radius:0.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.border{border-width:1px}.border-2{border-width:2px}.border-l{border-left-width:1px}.border-r{border-right-width:1px}.border-cyan-500{--tw-border-opacity:1;border-color:rgb(6 182 212 / var(--tw-border-opacity, 1))}.border-cyan-700{--tw-border-opacity:1;border-color:rgb(14 116 144 / var(--tw-border-opacity, 1))}.border-cyan-900{--tw-border-opacity:1;border-color:rgb(22 78 99 / var(--tw-border-opacity, 1))}.border-gray-700{--tw-border-opacity:1;border-color:rgb(55 65 81 / var(--tw-border-opacity, 1))}.border-gray-800{--tw-border-opacity:1;border-color:rgb(31 41 55 / var(--tw-border-opacity, 1))}.border-red-500{--tw-border-opacity:1;border-color:rgb(239 68 68 / var(--tw-border-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-cyan-900{--tw-bg-opacity:1;background-color:rgb(22 78 99 / var(--tw-bg-opacity, 1))}.bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.bg-gray-800{--tw-bg-opacity:1;background-color:rgb(31 41 55 / var(--tw-bg-opacity, 1))}.bg-gray-900{--tw-bg-opacity:1;background-color:rgb(17 24 39 / var(--tw-bg-opacity, 1))}.bg-green-900{--tw-bg-opacity:1;background-color:rgb(20 83 45 / var(--tw-bg-opacity, 1))}.bg-red-600{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity, 1))}.bg-red-900{--tw-bg-opacity:1;background-color:rgb(127 29 29 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-yellow-400{--tw-bg-opacity:1;background-color:rgb(250 204 21 / var(--tw-bg-opacity, 1))}.bg-yellow-600{--tw-bg-opacity:1;background-color:rgb(202 138 4 / var(--tw-bg-opacity, 1))}.bg-opacity-30{--tw-bg-opacity:0.3}.bg-opacity-95{--tw-bg-opacity:0.95}.bg-gradient-to-b{background-image:linear-gradient(to bottom, var(--tw-gradient-stops))}.from-black{--tw-gradient-from:#000 var(--tw-gradient-from-position);--tw-gradient-to:rgb(0 0 0 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.to-transparent{--tw-gradient-to:transparent var(--tw-gradient-to-position)}.p-2{padding:0.5rem}.p-4{padding:1rem}.p-8{padding:2rem}.px-4{padding-left:1rem;padding-right:1rem}.px-8{padding-left:2rem;padding-right:2rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-5{padding-top:1.25rem;padding-bottom:1.25rem}.text-center{text-align:center}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-2xl{font-size:1.5rem;line-height:2rem}.text-6xl{font-size:3.75rem;line-height:1}.text-\[10px\]{font-size:10px}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.uppercase{text-transform:uppercase}.tracking-wider{letter-spacing:0.05em}.tracking-widest{letter-spacing:0.1em}.text-black{--tw-text-opacity:1;color:rgb(0 0 0 / var(--tw-text-opacity, 1))}.text-cyan-200{--tw-text-opacity:1;color:rgb(165 243 252 / var(--tw-text-opacity, 1))}.text-cyan-300{--tw-text-opacity:1;color:rgb(103 232 249 / var(--tw-text-opacity, 1))}.text-cyan-400{--tw-text-opacity:1;color:rgb(34 211 238 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-green-400{--tw-text-opacity:1;color:rgb(74 222 128 / var(--tw-text-opacity, 1))}.text-green-500{--tw-text-opacity:1;color:rgb(34 197 94 / var(--tw-text-opacity, 1))}.text-red-200{--tw-text-opacity:1;color:rgb(254 202 202 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-yellow-500{--tw-text-opacity:1;color:rgb(234 179 8 / var(--tw-text-opacity, 1))}.opacity-0{opacity:0}.opacity-20{opacity:0.2}.mix-blend-screen{mix-blend-mode:screen}.shadow-\[0_0_10px_\#fbbf24\]{--tw-shadow:0 0 10px #fbbf24;--tw-shadow-colored:0 0 10px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-\[0_0_15px_\#fff\]{--tw-shadow:0 0 15px #fff;--tw-shadow-colored:0 0 15px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-\[0_0_30px_rgba\(0\2c 255\2c 255\2c 0\.2\)\]{--tw-shadow:0 0 30px rgba(0,255,255,0.2);--tw-shadow-colored:0 0 30px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.backdrop-blur-sm{--tw-backdrop-blur:blur(4px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-100{transition-duration:100ms}.duration-300{transition-duration:300ms}.duration-75{transition-duration:75ms}.hover\:bg-cyan-700:hover{--tw-bg-opacity:1;background-color:rgb(14 116 144 / var(--tw-bg-opacity, 1))}.hover\:bg-red-800:hover{--tw-bg-opacity:1;background-color:rgb(153 27 27 / var(--tw-bg-opacity, 1))}.focus\:border-cyan-400:focus{--tw-border-opacity:1;border-color:rgb(34 211 238 / var(--tw-border-opacity, 1))}.focus\:shadow-\[0_0_15px_\#0ff\]:focus{--tw-shadow:0 0 15px #0ff;--tw-shadow-colored:0 0 15px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.active\:scale-95:active{--tw-scale-x:.95;--tw-scale-y:.95;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}</style></head><body class="text-cyan-200 h-screen w-screen overflow-hidden relative">



  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Flight Controller (Landscape)</title>
  <script src="./Flight Controller (Landscape)_files/peerjs.min.js.ä¸‹è¼‰"></script>
  <script src="./Flight Controller (Landscape)_files/html5-qrcode" type="text/javascript"></script>
  <script src="./Flight Controller (Landscape)_files/saved_resource"></script>
  <style>
    body { 
      background-color: #000; 
      font-family: 'Courier New', monospace;
      overscroll-behavior: none;
    }
    
    /* ç¦æ­¢é è¨­æ‰‹å‹¢ */
    #screen-game, #screen-calibration {
      touch-action: none; 
      user-select: none;
      -webkit-user-select: none;
    }

    .neon-text { text-shadow: 0 0 5px #0ff, 0 0 10px #0ff; }
    
    /* å§¿æ…‹å„€çš„æº–å¿ƒ */
    .crosshair-h { width: 100%; height: 2px; background: cyan; position: absolute; top: 50%; transform: translateY(-50%); box-shadow: 0 0 5px cyan; }
    .crosshair-v { height: 100%; width: 2px; background: cyan; position: absolute; left: 50%; transform: translateX(-50%); box-shadow: 0 0 5px cyan; }
    
    /* QR Reader */
    #qr-reader { border: none !important; }
    #qr-reader video { object-fit: cover; border-radius: 8px; }

    /* å¼·åˆ¶æ©«å‘è¦†è“‹å±¤ */
    #orientation-guard {
      display: none;
    }
    @media screen and (orientation: portrait) {
      #orientation-guard { display: flex; }
    }
  </style>

<style>
/* DBG RESPONSIVE */
#dbg button{ font-size:12px; padding:7px 9px; }
#dbg{ font-size:12px; }
#dbg .row{ gap:6px; }
@media (max-width: 420px){
  #dbg{ max-height: 30vh; padding:6px; left:6px; right:6px; bottom:6px; }
  #dbg button{ font-size:11px; padding:6px 8px; }
  #dbgNote{ display:none; } /* å°è¢å¹•é è¨­æ”¶èµ·èªªæ˜ */
}
</style>


<style>
<style>
/* FORM RESPONSIVE (Controller main UI)
   ç›®æ¨™ï¼šHost ID / Passcode / QR æŒ‰éˆ•åœ¨å„ç¨®æ‰‹æ©Ÿå°ºå¯¸éƒ½ä¸æœƒè¢«åˆ‡æ‰ï¼Œä¸”è§¸æ§ç›®æ¨™è¶³å¤ å¤§
*/
html, body { height: 100%; }
* { box-sizing: border-box; }
:root { --safe-top: env(safe-area-inset-top, 0px); --safe-bottom: env(safe-area-inset-bottom, 0px); }

/* é¿å…åº•éƒ¨è¢«ç³»çµ±åˆ—åƒ */
body { padding-bottom: calc(var(--safe-bottom) + 8px); padding-top: calc(var(--safe-top) + 0px); }

/* è§¸æ§ç›®æ¨™ï¼šæŒ‰éˆ•è‡³å°‘ 44px */
#btn-connect, #btn-calibrate, #btn-scan-qr { min-height: 44px; }

/* å°é«˜åº¦ï¼ˆæ©«å‘å¸¸è¦‹ï¼‰ï¼šç¸®æ¨™é¡Œèˆ‡é–“è· */
@media (max-height: 520px) {
  h1.neon-text { margin-bottom: 12px !important; font-size: 20px !important; }
}

/* è¶…çª„ / æ©«å‘é«˜åº¦å¾ˆå°ï¼šQR æŒ‰éˆ•æ”¹æˆæ•´è¡Œï¼ˆä¸æ“ å£“è¼¸å…¥æ¡†ï¼‰ */
@media (max-width: 360px), (max-height: 420px) {
  #btn-scan-qr { width: 100% !important; height: 44px; }
}

/* ================================
   âœ… MOBILE BROWSER URL BAR FIX
   - é¿å…ä¸Šæ–¹ç¶²å€åˆ—/ä¸‹æ–¹å°è¦½åˆ—æ“ å£“é€ æˆæŒ‰éˆ•çœ‹ä¸åˆ°
   - ä½¿ç”¨ dvh/svh å–ä»£ 100vhï¼Œä¸¦å…è¨±å…§å®¹å¯æ²å‹•
   ================================ */
html, body { height: 100%; }

body{
  min-height: 100vh;   /* fallback */
  min-height: 100svh;  /* small viewport height */
  min-height: 100dvh;  /* dynamic viewport height */
}

/* å°å¯èƒ½çš„ä¸»å®¹å™¨ class åšä¿å®ˆè¦†è“‹ï¼ˆæœ‰å°±ç”Ÿæ•ˆï¼‰ */
#app, .app, .page, .wrap, .container, .root{
  min-height: 100vh;
  min-height: 100svh;
  min-height: 100dvh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: max(16px, env(safe-area-inset-bottom));
}

/* è‹¥æœ‰ç¡¬é–é«˜åº¦å°è‡´åº•éƒ¨è¢«åƒï¼Œå¼·åˆ¶æ”¾é–‹ */
.center, .screen, .panel{
  height: auto !important;
  min-height: 0 !important;
}

/* ROTATE overlay ä¸è¦åƒæ‰æ•´é æ²å‹•ï¼ˆåªåœ¨éœ€è¦æ™‚é¡¯ç¤ºï¼‰ */
#rotateOverlay, .rotateOverlay{
  pointer-events: auto;
}

</style>




  <!-- ============================= -->
  <!-- DEBUG OVERLAY (Controller)    -->
  <!-- ç”¨æ–¼ç¢ºèªæ˜¯å¦è¼‰åˆ°æ–°ç‰ˆæœ¬/éœ‡å‹•æ˜¯å¦è§£é–/æ˜¯å¦æ”¶åˆ° Host è¨Šæ¯ -->
  <!-- ============================= -->
  



  <!-- 0. ç›´å‘æ¨¡å¼è­¦å‘Š (å¼·åˆ¶æ©«å‘) -->
  <div id="orientation-guard" class="fixed inset-0 z-[999] bg-black flex flex-col items-center justify-center p-8 text-center">
    <div class="text-6xl mb-6 animate-pulse">â†»</div>
    <h2 class="text-2xl font-bold text-red-500 mb-2 uppercase tracking-widest">Rotate Device</h2>
    <p class="text-gray-400">è«‹å°‡æ‰‹æ©Ÿè½‰ç‚ºæ©«å‘ä»¥é€²è¡Œé£›è¡Œæ§åˆ¶</p>
  </div>

  <!-- 1. é€£ç·šç™»å…¥ä»‹é¢ -->
  <div id="connect-panel" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 p-4 transition-all duration-300">
    <h1 class="text-2xl font-bold mb-6 neon-text tracking-widest">FLIGHT LINK</h1>
    
    <div class="w-full max-w-sm space-y-4 relative z-50">
      <div>
        <label class="block text-xs uppercase tracking-wider mb-1 text-gray-500">Host ID</label>
        <div class="flex gap-2 flex-wrap">
          <input id="host-id-input" type="text" placeholder="Scan or Enter ID" class="flex-1 bg-gray-800 border border-cyan-700 text-cyan-300 p-4 rounded text-center text-xl focus:outline-none focus:border-cyan-400 focus:shadow-[0_0_15px_#0ff] uppercase">
          
          <button id="btn-scan-qr" class="bg-cyan-900 border border-cyan-500 text-white p-4 rounded hover:bg-cyan-700 active:scale-95 transition-transform" title="Scan QR Code">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
            </svg>
          </button>
        </div>
      </div>
      
      <div>
        <label class="block text-xs uppercase tracking-wider mb-1 text-gray-500">Passcode</label>
        <input id="passcode-input" type="text" placeholder="1234" value="1234" class="w-full bg-gray-800 border border-cyan-700 text-cyan-300 p-4 rounded text-center text-xl focus:outline-none focus:border-cyan-400">
      </div>
      
      <button id="btn-connect" class="w-full bg-cyan-900 hover:bg-cyan-700 text-white font-bold py-5 rounded-lg border border-cyan-500 uppercase tracking-widest text-xl shadow-lg active:scale-95 transition-transform">
        Initialize System
      </button>
      
      <p id="status" class="text-center text-sm text-yellow-500 h-5 mt-2">Ready to connect</p>
    </div>
  </div>

  <!-- QR æƒæä»‹é¢ -->
  <div id="qr-overlay" class="hidden absolute inset-0 z-[60] bg-black bg-opacity-95 flex flex-col items-center justify-center p-4">
    <div class="relative w-full max-w-sm bg-gray-900 p-2 rounded-lg border border-cyan-500 shadow-[0_0_30px_rgba(0,255,255,0.2)]">
      <h3 class="text-center text-cyan-400 mb-2 font-mono">SCAN HOST QR</h3>
      <div id="qr-reader" class="w-full h-64 bg-black overflow-hidden rounded"></div>
      <button id="btn-close-qr" class="mt-4 w-full py-3 bg-red-900 border border-red-500 text-red-200 rounded hover:bg-red-800">CANCEL</button>
    </div>
  </div>

  <!-- 2. æ ¡æ­£ä»‹é¢ (Flight Mode) -->
  <div id="screen-calibration" class="hidden absolute inset-0 z-40 bg-gray-900 flex flex-col items-center justify-center p-4">
    <h2 class="text-xl text-white mb-2 uppercase tracking-widest">Flight Sensor Calib</h2>
    <p id="cal-instruction" class="text-cyan-300 text-center mb-8 text-lg font-bold">Step 1: Hold Center</p>
    
    <!-- 2D æ ¡æ­£è¦–è¦º (æ–¹æ¡†) -->
    <div class="w-64 h-64 border-2 border-gray-700 rounded mb-8 relative bg-gray-900">
      <div class="absolute top-1/2 left-1/2 w-full h-[1px] bg-gray-700 -translate-x-1/2"></div>
      <div class="absolute top-1/2 left-1/2 h-full w-[1px] bg-gray-700 -translate-y-1/2"></div>
      <!-- ç§»å‹•çš„æ°£æ³¡ -->
      <div id="cal-bubble" class="absolute w-4 h-4 bg-yellow-400 rounded-full transform -translate-x-1/2 -translate-y-1/2 shadow-[0_0_10px_#fbbf24] transition-transform duration-75" style="top: 50%; left: 50%; transform: translate(-50%, -50%) translate(0px, 0px);"></div>
    </div>

    <button id="btn-calibrate" class="px-8 py-3 bg-yellow-600 text-black font-bold rounded uppercase text-xl w-64 shadow-lg active:scale-95">
      Set Center
    </button>
    <div class="mt-4 text-xs text-gray-500 font-mono" id="debug-orientation">P(Gam):0 R(Bet):0</div>
  </div>

  <!-- 3. éŠæˆ²ä»‹é¢ (Flight Stick) -->
  <div id="screen-game" class="hidden absolute inset-0 flex">
    <div class="absolute top-0 left-0 right-0 h-12 flex justify-between items-center px-4 pointer-events-none z-10 bg-gradient-to-b from-black to-transparent">
      <div class="text-xs font-mono text-gray-400">FLIGHT: <span class="text-green-400">ONLINE</span></div>
      <div id="debug-val" class="text-[10px] font-mono text-gray-600">waiting...</div>
    </div>

    <!-- å·¦å€ï¼šé–‹ç‚® (FIRE) -->
    <div id="zone-fire" class="w-1/2 h-full border-r border-gray-800 relative flex items-center justify-center">
      <!-- ä¿®æ­£ï¼šUI æ–‡å­—èˆ‡åœ–ç¤ºæ”¹ç‚ºæ”»æ“Šå‹ -->
      <div class="pointer-events-none opacity-20 text-red-500 font-bold text-6xl transform -rotate-90 tracking-widest">FIRE</div>
      <!-- é»æ“Šæ™‚çš„å…‰æ•ˆ -->
      <div id="hud-fire" class="absolute inset-0 pointer-events-none transition-opacity duration-100 opacity-0 bg-red-600 mix-blend-screen"></div>
    </div>

    <!-- å³å€ï¼šæ²¹é–€ (THRUST) -->
    <div id="zone-gas" class="w-1/2 h-full border-l border-gray-800 relative flex items-center justify-center">
      <div class="pointer-events-none opacity-20 text-green-500 font-bold text-6xl transform rotate-90 tracking-widest">THRUST</div>
      <div id="hud-gas" class="absolute inset-0 pointer-events-none transition-opacity duration-100 opacity-0 bg-green-900 mix-blend-screen"></div>
    </div>

    <!-- ä¸­å¤®ï¼šé£›è¡Œå§¿æ…‹å„€ (Joystick Visual) -->
    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
      <!-- å¤–æ¡† -->
      <div class="w-64 h-64 border border-cyan-900 rounded-full relative bg-black bg-opacity-30 backdrop-blur-sm overflow-hidden">
        <div class="crosshair-h"></div>
        <div class="crosshair-v"></div>
        
        <!-- ç§»å‹•çš„æº–å¿ƒé» -->
        <div id="joystick-dot" class="w-4 h-4 bg-white border-2 border-cyan-500 rounded-full absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 shadow-[0_0_15px_#fff]"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const els = {
    connectPanel: document.getElementById('connect-panel'),
    calPanel: document.getElementById('screen-calibration'),
    gamePanel: document.getElementById('screen-game'),
    qrOverlay: document.getElementById('qr-overlay'),
    hostId: document.getElementById('host-id-input'),
    passcode: document.getElementById('passcode-input'),
    btnConnect: document.getElementById('btn-connect'),
    btnScanQr: document.getElementById('btn-scan-qr'),
    btnCloseQr: document.getElementById('btn-close-qr'),
    status: document.getElementById('status'),
    calInstruction: document.getElementById('cal-instruction'),
    btnCalibrate: document.getElementById('btn-calibrate'),
    calBubble: document.getElementById('cal-bubble'),
    debugOri: document.getElementById('debug-orientation'),
    joystickDot: document.getElementById('joystick-dot'),
    hudGas: document.getElementById('hud-gas'),
    hudFire: document.getElementById('hud-fire'), // ä¿®æ­£ï¼šæŠ“å– Fire çš„ HUD
    debugVal: document.getElementById('debug-val')
  };

  let peer = null, conn = null;
  let html5QrCode = null;

  // æ„Ÿæ¸¬å™¨åŸå§‹æ•¸æ“š
  let rawBeta = 0;  // Beta: å·¦å³æ—‹è½‰ (Roll)
  let rawGamma = 0; // Gamma: å‰å¾Œå‚¾æ–œ (Pitch)

  // æ ¡æ­£æ•¸æ“š
  const CAL = { 
    centerBeta: 0, 
    centerGamma: 0, 
    maxPitchDiff: 30, // é è¨­ç¯„åœ
    maxRollDiff: 30 
  };
  
  // ç‹€æ…‹: 0=Center, 1=Range, 2=Done
  let calStep = 0; 
  
  // è¼¸å‡ºçµ¦éŠæˆ²çš„æ•¸æ“š (-1.0 ~ 1.0)
  // ä¿®æ­£ï¼šå°‡ brake æ”¹ç‚º fire
  let input = { pitch: 0, roll: 0, gas: false, fire: false };

  // ================================
  // ğŸ”” HAPTIC / VIBRATION (mobile-only)
  // åªä¿®éœ‡å‹•ï¼ˆä¸å‹•å…¶ä»–ç©æ³•/é€£ç·š/ç•«é¢ï¼‰
  //
  // å¤šæ•¸ç€è¦½å™¨æœƒé™åˆ¶éœ‡å‹•å¿…é ˆåœ¨ã€Œä½¿ç”¨è€…äº’å‹•ä¹‹å¾Œã€æ‰å…è¨±ã€‚
  // æˆ‘å€‘ç”¨ vibUnlocked ä¾†è¨˜éŒ„æ˜¯å¦å·²äº’å‹•ï¼›è‹¥å°šæœªè§£é–ï¼Œ
  // å…ˆæŠŠéœ‡å‹•æŒ‡ä»¤å­˜èµ·ä¾†ï¼Œç­‰ä¸‹ä¸€æ¬¡äº’å‹•æ™‚å†è£œéœ‡ã€‚
  // ================================
  let vibUnlocked = false;
  let pendingVibrate = null;

  function normalizePattern(p){
    if (p == null) return 30;
    if (typeof p === "number") return p;
    if (Array.isArray(p)) return p;
    return 30;
  }

  function safeVibrate(pattern){
    const p = normalizePattern(pattern);
    pendingVibrate = p;

    if (!(window.navigator && typeof window.navigator.vibrate === "function")) return false;
    if (!vibUnlocked) return false;

    try {
      window.navigator.vibrate(p);
      pendingVibrate = null;
      return true;
    } catch(e) {
      return false;
    }
  }

  function unlockVibration(){
    vibUnlocked = true;
    if (!(window.navigator && typeof window.navigator.vibrate === "function")) return;

    if (pendingVibrate != null) {
      try { window.navigator.vibrate(pendingVibrate); } catch(e){}
      pendingVibrate = null;
    } else {
      try { window.navigator.vibrate(1); } catch(e){}
    }
  }

  // ä¸€æ¬¡æ€§çš„ pointerdown è§£é–ï¼ˆé» Initialize / Set Center / éŠæˆ²è§¸æ§éƒ½æœƒè§¸ç™¼ï¼‰
  window.addEventListener("pointerdown", unlockVibration, { once: true, passive: true });

  // ================================
  // DEBUG WIRING
  // ================================
  const DBG_VERSION = "DEBUG-2025-12-17-02";
  const dbg = {
    root: document.getElementById("dbg"),
    ver: document.getElementById("dbgVer"),
    haptic: document.getElementById("dbgHaptic"),
    vibApi: document.getElementById("dbgVibrateApi"),
    vibRet: document.getElementById("dbgVibRet"),
    peer: document.getElementById("dbgPeer"),
    conn: document.getElementById("dbgConn"),
    last: document.getElementById("dbgLast"),
    lastH: document.getElementById("dbgLastH"),
    btnTest: document.getElementById("dbgBtnTest"),
    btnUnlock: document.getElementById("dbgBtnUnlock"),
    btnMin: document.getElementById("dbgBtnMin"),
    btnHide: document.getElementById("dbgBtnHide"),
  };

  function dbgSet(id, text){ if(id) id.textContent = text; }
  let lastVibReturn = "(none)";
  function dbgRefreshBasic(){
    dbgSet(dbg.ver, "VER: " + DBG_VERSION);
    const hasVibrate = !!(window.navigator && typeof window.navigator.vibrate === "function");
    dbgSet(dbg.vibApi, "vibrate(): " + (hasVibrate ? "YES" : "NO"));
    dbgSet(dbg.vibRet, "vibRet: " + lastVibReturn);
    dbgSet(dbg.haptic, "HAPTIC: " + (vibUnlocked ? "UNLOCKED" : "LOCKED"));
  }
  dbgRefreshBasic();

  // å¼·åŒ– unlockï¼šæ¯æ¬¡è§£é–/è£œéœ‡éƒ½åˆ·æ–° UI
  const _unlockVibration = unlockVibration;
  unlockVibration = function(){
    try { _unlockVibration(); } catch(e){}
    dbgRefreshBasic();
  };

  // å¼·åŒ– safeVibrateï¼šè¨˜éŒ„æœ€è¿‘ä¸€æ¬¡ pattern
  const _safeVibrate = safeVibrate;
  safeVibrate = function(pattern){
    dbgSet(dbg.lastH, JSON.stringify(pattern));
    // å…ˆèµ°åŸæœ¬çš„ä¿è­·æµç¨‹
    const ok = _safeVibrate(pattern);
    // å–å¾— vibrate() çš„å›å‚³å€¼ï¼ˆæœ‰äº›è£ç½®æœƒå› falseï¼‰
    try {
      if (window.navigator && typeof window.navigator.vibrate === "function") {
        const p = (typeof pattern === "number" || Array.isArray(pattern)) ? pattern : 30;
        lastVibReturn = String(window.navigator.vibrate(p));
      } else {
        lastVibReturn = "NO_API";
      }
    } catch(e) {
      lastVibReturn = "ERR";
    }
    dbgRefreshBasic();
    return ok;
  };

  // UI buttons
  dbg.btnTest?.addEventListener("click", () => {
    // ä½¿ç”¨è€…æ‰‹å‹¢ï¼šå…ˆç¢ºä¿è§£é–ï¼Œå†æ¸¬
    try { unlockVibration(); } catch(e) {}
    safeVibrate([100, 60, 100, 60, 200]);
    // éƒ¨åˆ†æ‰‹æ©Ÿéœ€è¦è¼ƒé•· pattern æ‰æœ‰æ„Ÿ
    setTimeout(()=>{ try{ safeVibrate(300); }catch(e){} }, 80);
  });

  dbg.btnUnlock?.addEventListener("click", () => {
    try { unlockVibration(); } catch(e) {}
    dbgRefreshBasic();
  });

  dbg.btnMin?.addEventListener("click", () => {
    if (!dbg.root) return;
    const isMin = dbg.root.classList.toggle("min");
    // æœ€å°åŒ–æ™‚åªç•™ç¬¬ä¸€è¡Œè³‡è¨Š + æŒ‰éˆ•åˆ—
    const note = document.getElementById("dbgNote");
    if (note) note.style.display = isMin ? "none" : "";
    // æŠŠé¢æ¿é«˜åº¦ç¸®å°
    dbg.root.style.maxHeight = isMin ? "14vh" : "34vh";
  });

dbg.btnHide?.addEventListener("click", () => {
    if (dbg.root) dbg.root.style.display = "none";
  });

  // åœ¨å¾Œé¢å»ºç«‹ peer/conn å¾Œï¼Œæˆ‘å€‘æœƒç”¨ interval è®€å–ç‹€æ…‹ï¼ˆä¸æ”¹åŸé‚è¼¯ï¼‰
  setInterval(() => {
    // peer / conn è®Šæ•¸åœ¨ä½ çš„åŸç¨‹å¼ä¸­å­˜åœ¨ï¼ˆåŒ scopeï¼‰
    try {
      dbgSet(dbg.peer, "peer: " + (peer ? (peer.id || "OK") : "null"));
    } catch(e) { dbgSet(dbg.peer, "peer: (n/a)"); }
    try {
      dbgSet(dbg.conn, "conn: " + (conn ? (conn.open ? "OPEN" : "CLOSED") : "null"));
    } catch(e) { dbgSet(dbg.conn, "conn: (n/a)"); }
    dbgRefreshBasic();
  }, 500);




  function setStatus(m) { els.status.textContent = m; }

  // 1. QR Code
  els.btnScanQr.addEventListener('click', () => { els.qrOverlay.classList.remove('hidden'); startQrScanner(); });
  els.btnCloseQr.addEventListener('click', stopQrScanner);

  function startQrScanner() {
    html5QrCode = new Html5Qrcode("qr-reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
      (txt) => {
        // æ”¯æ´ä¸‰ç¨® QR æ ¼å¼ï¼š
        // 1) ç´” HostIDï¼š 1234
        // 2) JSONï¼š {"hostId":"1234","passcode":"1234"}
        // 3) KEY=VALï¼š hostId=1234&passcode=1234 æˆ– hostId:1234|passcode:1234
        let hostId = "";
        let passcode = "";
        const s = String(txt || "").trim();

        // JSON
        try {
          const obj = JSON.parse(s);
          hostId = String(obj.hostId ?? obj.id ?? "").trim();
          passcode = String(obj.passcode ?? obj.pass ?? "").trim();
        } catch(e) {}

        if (!hostId) {
          // key-value
          const get = (k) => {
            const r1 = new RegExp(k + "\\s*[:=]\\s*([A-Za-z0-9_-]+)", "i").exec(s);
            if (r1) return r1[1];
            const r2 = new RegExp("[?&]" + k + "=([A-Za-z0-9_-]+)", "i").exec(s);
            if (r2) return r2[1];
            return "";
          };
          hostId = get("hostId") || get("id");
          passcode = get("passcode") || get("pass") || get("code");
        }

        if (!hostId) {
          // ç´”æ•¸å­—ï¼ˆHostIDï¼‰
          const r = /\b\d{3,8}\b/.exec(s);
          hostId = r ? r[0] : s;
        }

        els.hostId.value = hostId;
        if (passcode) els.passcode.value = passcode;

        stopQrScanner();
        setStatus("QR Loaded âœ…");
        safeVibrate(200)
      },
      (err) => {}
    ).catch(e => alert("Camera err: " + e));
  }
  function stopQrScanner() {
    if(html5QrCode) html5QrCode.stop().then(()=>{ html5QrCode.clear(); els.qrOverlay.classList.add('hidden'); }).catch(()=>{});
    else els.qrOverlay.classList.add('hidden');
  }

  // 2. é€£ç·š
  els.btnConnect.addEventListener('click', async () => {
    // âœ… ä½¿ç”¨è€…å·²é»æ“Šï¼šåœ¨æ‰‹å‹¢ä¸Šä¸‹æ–‡ä¸­è§£é–éœ‡å‹•
    try { unlockVibration(); } catch(e) {}
    const hid = els.hostId.value.trim();
    if (!hid) return setStatus("No Host ID");
    
    // iOS Permission
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      try { await DeviceOrientationEvent.requestPermission(); } catch (e) {}
    }
    try { document.documentElement.requestFullscreen(); } catch(e){}

    // å˜—è©¦é–å®šæ©«å‘ (éƒ¨åˆ†ç€è¦½å™¨æ”¯æ´)
    try { screen.orientation.lock('landscape').catch(()=>{}); } catch(e){}

    els.btnConnect.disabled = true; els.btnConnect.textContent = "Connecting...";
    peer = new Peer();
    peer.on('open', (id) => {
      conn = peer.connect(hid);
      conn.on('open', () => { setStatus("Verifying..."); conn.send({ type: "auth", pass: els.passcode.value }); });
      conn.on('data', (d) => {
        // ğŸ”” Host è§¸è¦ºå›é¥‹ï¼ˆéœ‡å‹•ï¼‰
        if (d?.type === "haptic") {
          // pattern: [30, 20, 60] æˆ–æ•¸å­—
          const p = d.pattern ?? 30;
          safeVibrate(p)
          return;
        }

        if (d?.type === "auth_result" && d.ok) {
          els.connectPanel.classList.add('hidden');
          els.calPanel.classList.remove('hidden');
          startCalibration();
        } else if (d?.type === "auth_result") {
          setStatus("Passcode Wrong"); els.btnConnect.disabled = false;
        }
      });
      conn.on('error', () => { setStatus("Conn Error"); els.btnConnect.disabled = false; });
    });
    peer.on('error', (e) => { setStatus("Err: "+e.type); els.btnConnect.disabled = false; });
  });

  // 3. é›™è»¸æ„Ÿæ¸¬è™•ç†
  window.addEventListener('deviceorientation', (e) => {
    if (e.beta !== null) rawBeta = e.beta;
    if (e.gamma !== null) rawGamma = e.gamma;
    updateCalVisuals();
  });

  // è¦–è¦ºå›é¥‹ï¼šåœ¨æ ¡æ­£ç•«é¢ç§»å‹•é»ƒè‰²æ°£æ³¡
  function updateCalVisuals() {
    if (calStep < 2) {
      // è»¸å‘é‚è¼¯ï¼šPitch(Gamma), Roll(Beta)
      els.debugOri.textContent = `P(Gam):${rawGamma.toFixed(0)} R(Bet):${rawBeta.toFixed(0)}`;
      
      let dBeta = rawBeta - (calStep === 0 ? 0 : CAL.centerBeta);
      let dGamma = rawGamma - (calStep === 0 ? 0 : CAL.centerGamma);
      
      let y = Math.max(-100, Math.min(100, dGamma * 3));  // Gamma æ§åˆ¶ä¸Šä¸‹ (Pitch)
      let x = Math.max(-100, Math.min(100, dBeta * 3));   // Beta æ§åˆ¶å·¦å³ (Roll)
      
      els.calBubble.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
    }
  }

  // æ ¡æ­£æµç¨‹ (Flight Mode: Center -> Range)
  function startCalibration() {
    calStep = 0;
    els.calInstruction.textContent = "1. å¹³æ‹¿æ‰‹æ©Ÿ (è¨­å®šä¸­å¿ƒ)";
    els.btnCalibrate.textContent = "è¨­å®šä¸­å¿ƒé»";
    els.btnCalibrate.className = "px-8 py-3 bg-cyan-600 text-white font-bold rounded shadow-lg w-64";
  }

  let tempMaxPitch = 0;
  let tempMaxRoll = 0;

  els.btnCalibrate.addEventListener('click', () => {
    // âœ… ä½¿ç”¨è€…å·²é»æ“Šï¼šå†æ¬¡ç¢ºä¿éœ‡å‹•å¯ç”¨
    try { unlockVibration(); } catch(e) {}
    if (calStep === 0) {
      // Step 1: è¨˜éŒ„ä¸­å¿ƒ
      CAL.centerBeta = rawBeta;
      CAL.centerGamma = rawGamma;
      
      calStep = 1;
      els.calInstruction.textContent = "2. å¤§å¹…åº¦è½‰å‹•æ‰‹æ©Ÿ (è¨­å®šç¯„åœ)";
      els.btnCalibrate.textContent = "å®Œæˆæ ¡æ­£";
      els.btnCalibrate.className = "px-8 py-3 bg-green-600 text-white font-bold rounded shadow-lg w-64";
      
      // åˆå§‹æœ€å°å€¼
      tempMaxPitch = 10;
      tempMaxRoll = 10;
      
    } else if (calStep === 1) {
      // Step 2: å®Œæˆ
      CAL.maxPitchDiff = Math.max(20, tempMaxPitch);
      CAL.maxRollDiff = Math.max(20, tempMaxRoll);

      calStep = 2;
      els.calPanel.classList.add('hidden');
      els.gamePanel.classList.remove('hidden');
      loop();
    }
  });

  // åœ¨ Step 1 -> Step 2 æœŸé–“æŒçºŒæ›´æ–°æœ€å¤§ç¯„åœ
  function trackMaxRange() {
    if (calStep === 1) {
      let dP = Math.abs(rawGamma - CAL.centerGamma); // Pitch (Gamma)
      let dR = Math.abs(rawBeta - CAL.centerBeta);   // Roll (Beta)
      if (dP > tempMaxPitch) tempMaxPitch = dP;
      if (dR > tempMaxRoll) tempMaxRoll = dR;
    }
    requestAnimationFrame(trackMaxRange);
  }
  trackMaxRange();

  // è§¸æ§ (Gas / Fire)
  function onTouch(e) {
    if (els.gamePanel.classList.contains('hidden')) return;
    if(e.cancelable) e.preventDefault();
    
    let g = false, f = false; // g=Gas, f=Fire
    let hw = window.innerWidth / 2;
    
    for (let i=0; i<e.touches.length; i++) {
      if (e.touches[i].clientX > hw) {
        g = true; // Right = Gas
      } else {
        f = true; // Left = Fire (Attack)
      }
    }
    input.gas = g;
    input.fire = f; // ç´€éŒ„é–‹ç«ç‹€æ…‹
    
    els.hudGas.style.opacity = g ? 1 : 0;
    els.hudFire.style.opacity = f ? 1 : 0;
  }
  window.addEventListener('touchstart', onTouch, {passive:false});
  window.addEventListener('touchmove', onTouch, {passive:false});
  window.addEventListener('touchend', onTouch, {passive:false});

  /* ================================================================================
     ğŸ› ï¸ éµç›¤é£›è¡Œæ¨¡æ“¬å™¨ (Flight Simulator Mode)
     W/S æˆ– ä¸Š/ä¸‹ï¼šæ§åˆ¶ Pitch (Gamma)
     A/D æˆ– å·¦/å³ï¼šæ§åˆ¶ Roll (Beta)
     Space: æ²¹é–€ | Shift: é–‹ç‚® (Fire)
   ================================================================================
  */
  window.addEventListener('keydown', (e) => {
    // Pitch (æ©Ÿé ­ä¸Šä¸‹) -> Gamma
    if (e.key === 'ArrowUp' || e.key === 'w') rawGamma = -45;
    if (e.key === 'ArrowDown' || e.key === 's') rawGamma = 45;
    
    // Roll (æ©Ÿç¿¼å·¦å³) -> Beta
    if (e.key === 'ArrowLeft' || e.key === 'a') rawBeta = -45;
    if (e.key === 'ArrowRight' || e.key === 'd') rawBeta = 45;
    
    // æŒ‰éˆ•
    if (e.key === ' ') { input.gas = true; els.hudGas.style.opacity = 1; }
    // ä¿®æ­£ï¼šShift è§¸ç™¼é–‹ç‚®
    if (e.key === 'Shift') { input.fire = true; els.hudFire.style.opacity = 1; }
    
    updateCalVisuals();
  });

  window.addEventListener('keyup', (e) => {
    if (['ArrowUp','ArrowDown','w','s'].includes(e.key)) rawGamma = 0;
    if (['ArrowLeft','ArrowRight','a','d'].includes(e.key)) rawBeta = 0;
    
    if (e.key === ' ') { input.gas = false; els.hudGas.style.opacity = 0; }
    // ä¿®æ­£ï¼šæ”¾é–‹ Shift åœæ­¢é–‹ç‚®
    if (e.key === 'Shift') { input.fire = false; els.hudFire.style.opacity = 0; }
    
    updateCalVisuals();
  });
  /* ================================================================================ */

  function loop() {
    requestAnimationFrame(loop);
    
    // æ©«å‘è¨ˆç®—é‚è¼¯
    let dP = rawGamma - CAL.centerGamma;
    let normP = dP / CAL.maxPitchDiff;
    
    let dR = rawBeta - CAL.centerBeta;
    let normR = dR / CAL.maxRollDiff;
    
    // Clamp
    input.pitch = parseFloat(Math.max(-1, Math.min(1, normP)).toFixed(3));
    input.roll  = parseFloat(Math.max(-1, Math.min(1, normR)).toFixed(3));

    // UI æ›´æ–°
    let joyX = input.roll * 100; 
    let joyY = input.pitch * 100; 
    
    els.joystickDot.style.transform = `translate(-50%, -50%) translate(${joyX}px, ${joyY}px)`;
    // ä¿®æ­£ï¼šDebug é¡¯ç¤º F (Fire)
    els.debugVal.textContent = `P:${input.pitch} R:${input.roll} G:${input.gas?1:0} F:${input.fire?1:0}`;
  }

  // å‚³è¼¸ Loop (30FPS)
  setInterval(() => {
    if (calStep === 2 && conn && conn.open) {
      // ä¿®æ­£ï¼šå‚³è¼¸è³‡æ–™å¢åŠ  fire æ¬„ä½
      conn.send({
        type: "flight_input", 
        pitch: input.pitch,
        roll: input.roll,
        gas: input.gas,
        fire: input.fire // é€™è£¡å‚³é€ true/false
      });
    }
  }, 33);

})();
</script>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const payloadInput = $("payloadInput");
  const btnParse = $("btnParsePayload");
  const btnHide = $("btnHidePayload");
  const panel = $("payloadPanel");

  function parsePayload(txt){
    const s = String(txt||"").trim();
    let hostId="", passcode="";
    try{
      const obj = JSON.parse(s);
      hostId = String(obj.hostId ?? obj.id ?? "").trim();
      passcode = String(obj.passcode ?? obj.pass ?? "").trim();
    }catch(e){}
    if(!hostId){
      const get = (k)=>{
        const r1 = new RegExp(k + "\\s*[:=]\\s*([A-Za-z0-9_-]+)", "i").exec(s);
        if(r1) return r1[1];
        const r2 = new RegExp("[?&]" + k + "=([A-Za-z0-9_-]+)", "i").exec(s);
        if(r2) return r2[1];
        return "";
      };
      hostId = get("hostId") || get("id");
      passcode = get("passcode") || get("pass") || get("code");
    }
    if(!hostId){
      const r = /\b\d{3,8}\b/.exec(s);
      hostId = r ? r[0] : s;
    }
    return {hostId, passcode};
  }

  btnParse?.addEventListener("click", ()=>{
    const {hostId, passcode} = parsePayload(payloadInput.value);
    const hostIdEl = document.querySelector("#hostId") || document.querySelector("input[name='hostId']") || document.querySelector("input[id*='host']");
    const passEl   = document.querySelector("#passcode") || document.querySelector("input[name='passcode']") || document.querySelector("input[id*='pass']");
    if(hostIdEl) hostIdEl.value = hostId;
    if(passEl && passcode) passEl.value = passcode;
    safeVibrate(80)
  });

  btnHide?.addEventListener("click", ()=>{ panel.style.display="none"; });
})();
</script></body></html>
